import cv2
import base64
import time
from openai import OpenAI

# Initialize OpenAI client with your API key
client = OpenAI(api_key="YOUR-OPENAI-API-KEY-HERE")  # <-- put your API key here

# Function to capture image from USB webcam
def capture_image(filename="coin.jpg"):
    cap = cv2.VideoCapture(0)  # If webcam not at 0, try 1
    if not cap.isOpened():
        raise Exception("Could not open webcam")
    
    time.sleep(2)  # Let the camera warm up
    ret, frame = cap.read()
    if not ret:
        raise Exception("Failed to capture image from webcam")

    cv2.imwrite(filename, frame)
    cap.release()

# Function to encode image as base64
def encode_image(image_path):
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode("utf-8")

# Main function
def analyze_coin():
    image_path = "coin.jpg"
    capture_image(image_path)
    print(f"Image captured and saved to {image_path}")

    base64_image = encode_image(image_path)

    # Create the chat completion request
    response = client.chat.completions.create(
        model="gpt-4-vision-preview",  # or gpt-4o if available
        messages=[
            {
                "role": "user",
                "content": [
                    {
                        "type": "text",
                        "text": (
                            "You are an expert coin appraiser and professional numismatist. "
                            "You specialize in identifying coins by mint year, denomination, origin, and condition. "
                            "Analyze the following image of a coin and tell me:\n"
                            "- Likely year\n"
                            "- Mint mark (if visible)\n"
                            "- Country of origin\n"
                            "- Denomination (e.g., cent, quarter, etc.)\n"
                            "- Estimated coin grade (Poor, Fine, VF, XF, MS-65, etc.)\n"
                            "Be very detailed and specific. Only guess if absolutely necessary. "
                            "Explain anything unclear about the coin or image."
                        )
                    },
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{base64_image}"
                        }
                    },
                ]
            }
        ],
        max_tokens=300,
    )

    result = response.choices[0].message.content
    print("\n--- Analysis Result ---")
    print(result)

if __name__ == "__main__":
    analyze_coin()
